<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Billing — Brahmastra</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #fff;
            min-height: 100vh;
            padding: 20px
        }

        .container {
            max-width: 1200px;
            margin: 0 auto
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 20px 24px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1)
        }

        .header-left h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800
        }

        .header-left .subtitle {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
            margin-top: 4px
        }

        .back-btn {
            padding: 10px 22px;
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s
        }

        .costs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 24px
        }

        .cost-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 14px;
            padding: 22px;
            border: 1px solid rgba(255, 255, 255, 0.08)
        }

        .cost-card .label {
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px
        }

        .cost-card .amount {
            font-size: 2.2rem;
            font-weight: 800
        }

        .cost-card .period {
            color: rgba(255, 255, 255, 0.35);
            font-size: 0.8rem;
            margin-top: 4px
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 18px;
            padding: 24px;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 16px
        }

        .breakdown-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04)
        }

        .breakdown-row:last-child {
            border: none
        }

        .breakdown-label {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .breakdown-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px
        }

        .breakdown-name {
            font-size: 0.9rem
        }

        .breakdown-value {
            font-weight: 700
        }

        .breakdown-pct {
            color: rgba(255, 255, 255, 0.35);
            font-size: 0.8rem;
            margin-left: 8px
        }

        .bar-container {
            height: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            margin-top: 16px;
            overflow: hidden;
            display: flex
        }

        .bar-segment {
            height: 100%;
            transition: width 0.5s
        }

        .tip-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            margin-bottom: 12px
        }

        .tip-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 6px
        }

        .tip-desc {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
            line-height: 1.5
        }

        .tip-savings {
            color: #10b981;
            font-weight: 600;
            font-size: 0.85rem;
            margin-top: 6px
        }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 8px;
            font-size: 0.72rem;
            font-weight: 600;
            margin-left: 8px
        }

        .badge-easy {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981
        }

        .badge-medium {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b
        }

        .badge-advanced {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.88rem
        }

        .info-label {
            color: rgba(255, 255, 255, 0.4)
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="url(#bgrd)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="vertical-align:middle;margin-right:8px">
                        <defs>
                            <linearGradient id="bgrd" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#667eea" />
                                <stop offset="100%" style="stop-color:#764ba2" />
                            </linearGradient>
                        </defs>
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>Billing & Costs</h1>
                <p class="subtitle">AWS infrastructure cost tracking & optimization</p>
            </div>
            <a class="back-btn" href="index.html">← Back to Dashboard</a>
        </header>

        <div class="costs">
            <div class="cost-card">
                <div class="label">Daily Cost</div>
                <div class="amount" id="dailyCost" style="color:#10b981">$-</div>
                <div class="period">per day (24h)</div>
            </div>
            <div class="cost-card">
                <div class="label">Monthly Cost</div>
                <div class="amount" id="monthlyCost" style="color:#667eea">$-</div>
                <div class="period">estimated per month</div>
            </div>
            <div class="cost-card">
                <div class="label">Yearly Estimate</div>
                <div class="amount" id="yearlyCost" style="color:#f59e0b">$-</div>
                <div class="period">projected annually</div>
            </div>
            <div class="cost-card">
                <div class="label">Running Cost</div>
                <div class="amount" id="runningCost" style="color:#764ba2">$-</div>
                <div class="period" id="runningHours">since startup</div>
            </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
            <div class="card">
                <div class="card-title"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                        viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" style="vertical-align:middle;margin-right:8px">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>Cost Breakdown (Monthly)</div>
                <div id="breakdownContainer"></div>
                <div class="bar-container" id="costBar"></div>
            </div>
            <div class="card">
                <div class="card-title"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                        viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" style="vertical-align:middle;margin-right:8px">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>Instance Info</div>
                <div id="instanceInfo"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                    fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="vertical-align:middle;margin-right:8px">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>Cost Saving Tips</div>
            <div id="tipsContainer">
                <div style="text-align:center;color:rgba(255,255,255,0.3);padding:20px">Loading tips...</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '';
        let token = localStorage.getItem('jwt_token');
        if (!token) window.location.href = 'login.html';
        function headers() { return { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' } }

        async function refreshToken() {
            const rt = localStorage.getItem('refresh_token'); if (!rt) return false;
            try {
                const r = await fetch(API_URL + '/api/auth/refresh', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ refresh_token: rt }) });
                if (!r.ok) return false; const d = await r.json(); token = d.access_token; localStorage.setItem('jwt_token', token); localStorage.setItem('refresh_token', d.refresh_token); return true
            } catch (e) { return false }
        }
        async function apiFetch(path) {
            let r = await fetch(API_URL + path, { headers: headers() });
            if (r.status === 401) {
                const ok = await refreshToken(); if (!ok) { localStorage.clear(); window.location.href = 'login.html'; return null }
                r = await fetch(API_URL + path, { headers: headers() })
            } return r;
        }

        const colors = { ec2: '#667eea', ebs: '#764ba2', data_transfer: '#f59e0b' };

        async function loadBilling() {
            try {
                const r = await apiFetch('/api/billing/breakdown');
                if (!r || !r.ok) return;
                const d = await r.json();

                document.getElementById('dailyCost').textContent = '$' + d.daily.total.toFixed(2);
                document.getElementById('monthlyCost').textContent = '$' + d.monthly.total.toFixed(2);
                document.getElementById('yearlyCost').textContent = '$' + d.yearly_estimate.total.toFixed(2);
                document.getElementById('runningCost').textContent = '$' + d.running.cost_so_far.toFixed(3);
                document.getElementById('runningHours').textContent = d.running.hours_running.toFixed(1) + ' hours running';

                // Breakdown
                const bc = document.getElementById('breakdownContainer');
                const items = [
                    { name: 'EC2 Compute', amount: d.monthly.ec2, pct: d.breakdown_percentage.ec2, color: colors.ec2 },
                    { name: 'EBS Storage', amount: d.monthly.ebs, pct: d.breakdown_percentage.ebs, color: colors.ebs },
                    { name: 'Data Transfer', amount: d.monthly.data_transfer, pct: d.breakdown_percentage.data_transfer, color: colors.data_transfer },
                ];
                bc.innerHTML = items.map(i => `<div class="breakdown-row">
            <div class="breakdown-label"><div class="breakdown-dot" style="background:${i.color}"></div><span class="breakdown-name">${i.name}</span></div>
            <div><span class="breakdown-value">$${i.amount.toFixed(2)}</span><span class="breakdown-pct">${i.pct}%</span></div>
        </div>`).join('');

                document.getElementById('costBar').innerHTML = items.map(i => `<div class="bar-segment" style="width:${i.pct}%;background:${i.color}"></div>`).join('');

                // Instance info
                document.getElementById('instanceInfo').innerHTML = `
            <div class="info-row"><span class="info-label">Instance Type</span><span style="font-weight:600">${d.instance_type}</span></div>
            <div class="info-row"><span class="info-label">Instance ID</span><span style="font-family:monospace;font-size:0.82rem">${d.instance_id}</span></div>
            <div class="info-row"><span class="info-label">EBS Volume</span><span>${d.ebs_size_gb} GB (gp3)</span></div>
            <div class="info-row"><span class="info-label">Region</span><span>ap-south-1 (Mumbai)</span></div>
            <div class="info-row"><span class="info-label">Pricing</span><span style="color:rgba(255,255,255,0.4);font-size:0.82rem">${d.pricing_note}</span></div>
        `;
            } catch (e) { console.error(e) }
        }

        async function loadTips() {
            try {
                const r = await apiFetch('/api/billing/tips');
                if (!r || !r.ok) return;
                const tips = await r.json();
                const tc = document.getElementById('tipsContainer');
                tc.innerHTML = tips.map(t => `<div class="tip-card">
            <div class="tip-title">${t.title}<span class="badge badge-${t.difficulty}">${t.difficulty}</span></div>
            <div class="tip-desc">${t.description}</div>
            <div class="tip-savings">Potential savings: $${t.potential_savings}/month</div>
        </div>`).join('') || '<div style="text-align:center;color:rgba(255,255,255,0.3);padding:20px">No tips available</div>';
            } catch (e) { console.error(e) }
        }

        loadBilling(); loadTips(); setInterval(loadBilling, 30000);
    </script>
</body>

</html>